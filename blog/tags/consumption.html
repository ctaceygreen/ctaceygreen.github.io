<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Less Intimidating Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Less Intimidating Blog Atom Feed"><title data-react-helmet="true">One post tagged with &quot;consumption&quot; | Less Intimidating</title><meta data-react-helmet="true" property="og:title" content="One post tagged with &quot;consumption&quot; | Less Intimidating"><meta data-react-helmet="true" property="og:url" content="https://ctaceygreen.github.io/blog/tags/consumption"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="blog_tags_posts"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://ctaceygreen.github.io/blog/tags/consumption"><link data-react-helmet="true" rel="alternate" href="https://ctaceygreen.github.io/blog/tags/consumption" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://ctaceygreen.github.io/blog/tags/consumption" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.348916db.css">
<link rel="preload" href="/assets/js/runtime~main.d1b7cdc7.js" as="script">
<link rel="preload" href="/assets/js/main.422f3649.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="https://avatars.githubusercontent.com/u/11404995?v=4" alt="My Site Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="https://avatars.githubusercontent.com/u/11404995?v=4" alt="My Site Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"><b class="navbar__title">Less Intimidating - Chris Tacey-Green</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ctaceygreen" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_2i4l react-toggle--checked react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-tags-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">Recent posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/paved-paths-series-part-2-a-one-pager">Paved Paths Series - Part 2 - A One Pager</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/azure-consumption-functions-healthcheck-with-deployment-slots">How do I check the health of my Azure Consumption Functions when swapping Deployment Slots?</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/returning">Returning</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/welcome">Welcome</a></li></ul></nav></aside><main class="col col--7"><header class="margin-bottom--xl"><h1>One post tagged with &quot;consumption&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/blog/azure-consumption-functions-healthcheck-with-deployment-slots">How do I check the health of my Azure Consumption Functions when swapping Deployment Slots?</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2023-04-30T10:23:13.683Z">April 30, 2023</time> Â· 4 min read</div><div class="avatar margin-vert--md"><a href="https://github.com/ctaceygreen" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/11404995?v=4" alt="Chris Tacey-Green"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/ctaceygreen" target="_blank" rel="noopener noreferrer">Chris Tacey-Green</a></div><small class="avatar__subtitle">Engineer, Architect, Human</small></div></div></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="setting-the-scene"></a>Setting the scene<a class="hash-link" href="#setting-the-scene" title="Direct link to heading">#</a></h2><p>Okay that title has quite a few elements to it, so let&#x27;s break down exactly what we&#x27;re trying to do here...</p><p>Our situation:</p><ul><li>An Azure Function running on a consumption plan</li><li><a href="https://docs.microsoft.com/en-us/azure/app-service/deploy-staging-slots" target="_blank" rel="noopener noreferrer">Deployment slots</a> configured within our IaC (a guide on these could be a separate post)</li><li>An ADO pipeline that deploys our IaC, code and then swaps our staging and production slot</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="so-whats-the-problem-here"></a>So what&#x27;s the problem here?<a class="hash-link" href="#so-whats-the-problem-here" title="Direct link to heading">#</a></h2><p>Our problem is that with the current setup, swapping slots on a consumption Function assumes healthiness based on loading the root URL of your Function App. This may be suitable for simple Functions, but as soon as your Function has downstream dependencies (such as a reliance on a DB, queue or other API), our requirements become more complicated. Ideally, our deployment process would look something like :</p><ul><li>Deploy infrastructure</li><li>Deploy code to staging slot</li><li>Check downstream dependencies are correctly configured and accessible to staging slot</li><li>Swap staging and production slot</li></ul><p>Hopefully you can see now that our root URL is letting us down slightly.</p><p>This is where we can turn to health-checks. In many services (App Service, Kubernetes etc), zero-downtime deployments utilise health probes, which hit a predefined HTTP endpoint to determine that your app is ready and healthy. An experienced blogger and all-round smart guy named John Reilly has already created a similar post <a href="https://blog.johnnyreilly.com/2021/02/11/azure-app-service-health-checks-and-zero-downtime-deployments" target="_blank" rel="noopener noreferrer">here</a> to explain how we can achieve this for Azure App Service. This process can be followed if you&#x27;re running your Functions on an App Service plan. If only this worked for consumption Functions too, my post would be completely unnecessary!
Unfortunately, it doesn&#x27;t. The <code>healthcheckPath</code> used in App Service to facilitate this functionality is not supported on the consumption plan. Annoying, but we still have a solution!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="the-solution"></a>The solution<a class="hash-link" href="#the-solution" title="Direct link to heading">#</a></h2><p>There are some sneaky appsettings that we can set on our Function. These configure which endpoint is used during slot warmup to check your slot is healthy. The appsettings are as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI json"><pre tabindex="0" class="prism-code language-json codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token property">&quot;appsettings&quot;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;WEBSITE_WARMUP_PATH&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;[parameters(&#x27;healthcheckPath&#x27;)]&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;WEBSITE_SWAP_WARMUP_PING_PATH&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;[parameters(&#x27;healthcheckPath&#x27;)]&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;WEBSITE_SWAP_WARMUP_PING_STATUSES&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token property">&quot;value&quot;</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;200&quot;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ...</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><code>WEBSITE_WARMUP_PATH</code> - Used in a few different areas of Azure. The reason we need it is because we have authentication enabled across all endpoints of our Function. Unlike the healthcheckPath functionality of app-service, the Function slot warmup process does not run &#x27;behind&#x27; the auth/ip restriction layer. Therefore, this appsetting specifies that the authentication layer should ignore this path and allow anonymous calls. This should be considered carefully with your use-case, ensuring that you&#x27;re not opening yourself up to DOS attacks or returning sensitive information that can be used as a security hole.</li><li><code>WEBSITE_SWAP_WARMUP_PING_PATH</code> - The path to your healthcheck/ping endpoint on your Function. e.g. &#x27;/api/healthcheck&#x27;</li><li><code>WEBSITE_SWAP_WARMUP_PING_STATUSES</code> - The statuses that you will accept as a successful response from your healthcheck endpoint. Without this, Azure will consider some redirect status codes as successful responses, so in our example we&#x27;re making this much more specific with just a &#x27;200&#x27; considered successful.</li></ul><p>After adding this into your ARM template for the Function <code>Microsoft.Web/Sites</code> and it&#x27;s associated slot, you&#x27;re good to go! The final step is to ensure that your ADO pipeline is running the task below to swap slots on your Function:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yml"><pre tabindex="0" class="prism-code language-yml codeBlock_rtdJ thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token key atrule">task</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> AzureAppServiceManager@0</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">displayName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Swap Staging Slot with Production&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">inputs</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">action</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;Swap Slots&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">azureSubscription</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;$(azureSubscription)&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">resourceGroupName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(resourceGroupName)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">webAppName</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> $(functionName)</span></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">SourceSlot</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;stage&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Running this ADO pipeline step will now check your <code>WEBSITE_SWAP_WARMUP_PING_PATH</code> is returning the expected status before swapping your slot into production. This should greatly reduce the likelihood of a consumption Function being deployed to production with misconfigured dependencies (e.g. invalid connection-string). You could easily implement this pattern for any consumption Functions within your estate, even non-http-triggers, all you&#x27;d need to do is ensure that an associated healthcheck http-trigger Function was deployed alongside it.</p><p>That should do us for this one! If anything isn&#x27;t clear, get in touch and I&#x27;d be happy to provide more reproducable examples of the entire ARM template and pipeline steps.</p><p>Until next time...</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/blog/tags/deployment-slots">deployment-slots</a><a class="margin-horiz--sm" href="/blog/tags/healthcheck">healthcheck</a><a class="margin-horiz--sm" href="/blog/tags/consumption">consumption</a><a class="margin-horiz--sm" href="/blog/tags/function">function</a><a class="margin-horiz--sm" href="/blog/tags/azure">azure</a></div><div class="col text--right"><a aria-label="Read more about How do I check the health of my Azure Consumption Functions when swapping Deployment Slots?" href="/blog/azure-consumption-functions-healthcheck-with-deployment-slots"><b>Read More</b></a></div></footer></article></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://www.linkedin.com/in/chris-tacey-green-02a66b100/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/ctaceygreen" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/ctaceygreen" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 Chris Tacey-Green. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d1b7cdc7.js"></script>
<script src="/assets/js/main.422f3649.js"></script>
</body>
</html>